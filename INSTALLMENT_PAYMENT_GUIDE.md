# 分期付款功能使用指南

## 概述

现在系统支持域名分期付款功能，可以正确处理分期收款和中断的情况。

## 新增交易类型

### 1. 分期付款 (installment_payment)
- **用途**：记录每期收到的分期款项
- **特点**：计入总收入，参与利润计算
- **颜色标识**：绿色 (emerald-100/emerald-800)

### 2. 分期退款 (installment_refund)
- **用途**：记录分期中断后的退款
- **特点**：从总收入中扣除
- **颜色标识**：橙色 (orange-100/orange-800)

## 使用场景示例

### 场景：域名分期出售 12 期

1. **域名出售** (type: 'sell')
   - 金额：$12,000
   - 分期：12 期
   - 每期：$1,000

2. **分期收款** (type: 'installment_payment')
   - 第1期：$1,000
   - 第2期：$1,000
   - 第3期：$1,000
   - 第4期：$1,000
   - 第5期：$1,000
   - 第6期：$1,000

3. **客户中断付款**
   - 已收到：$6,000
   - 域名收回：状态从 'sold' 改为 'active'

4. **继续出售** (type: 'sell')
   - 新买家：$8,000
   - 分期：8 期
   - 每期：$1,000

5. **新分期收款** (type: 'installment_payment')
   - 第1期：$1,000
   - 第2期：$1,000
   - 第3期：$1,000
   - 第4期：$1,000

## 财务计算逻辑

### 总收入计算
```typescript
// 包含所有销售和分期付款
const totalRevenue = transactions
  .filter(t => t.type === 'sell' || t.type === 'installment_payment')
  .reduce((sum, t) => sum + (t.net_amount || t.amount), 0);
```

### 利润计算
- **已收款分期**：计入利润
- **中断分期**：已收款项仍计入利润
- **域名收回**：可以重新出售

## 操作步骤

### 1. 添加分期付款记录
1. 点击 "Add Transaction"
2. 选择交易类型：**Installment Payment**
3. 填写金额和日期
4. 添加备注说明分期期数

### 2. 处理分期中断
1. 域名状态：从 'sold' 改为 'active'
2. 已收分期：保持为 'installment_payment' 类型
3. 可以重新出售域名

### 3. 重新出售
1. 添加新的 'sell' 交易
2. 继续添加 'installment_payment' 记录

## 财务报告影响

### 仪表板显示
- **总收入**：包含所有分期付款
- **净利润**：已收分期款项计入利润
- **ROI**：基于实际收到的款项计算

### 报告分析
- **月度分析**：分期付款按实际收款日期计入
- **年度分析**：包含所有分期收款
- **域名分析**：显示分期付款历史

## 最佳实践

### 1. 记录规范
- 每期分期付款单独记录
- 备注中说明期数（如：第1期/12期）
- 使用统一的货币和汇率

### 2. 状态管理
- 分期进行中：域名状态保持 'sold'
- 分期中断：域名状态改为 'active'
- 重新出售：添加新的 'sell' 交易

### 3. 财务跟踪
- 定期检查分期收款情况
- 及时更新域名状态
- 保持交易记录的完整性

## 注意事项

1. **已收分期款项**：即使分期中断，已收款项仍计入利润
2. **域名收回**：可以重新出售，不影响已收分期的利润计算
3. **重复出售**：同一域名可以多次出售，每次都是独立的交易
4. **财务准确性**：分期付款确保财务数据的准确性和完整性

## 技术实现

### 类型定义
```typescript
type: 'buy' | 'renew' | 'sell' | 'transfer' | 'fee' | 'marketing' | 'advertising' | 'installment_payment' | 'installment_refund';
```

### 财务计算
- 所有 `installment_payment` 类型交易计入收入
- 所有 `installment_refund` 类型交易从收入中扣除
- 支持多语言显示（中文/英文）

这个功能确保了分期付款业务的财务数据准确性和完整性！

# 分期付款配置功能使用指南

## 功能概述

现在系统支持灵活的分期付款配置，包括首付（downpayment）、等额分期和不等额最后一期付款。

## 新增功能特性

### 1. 付款方式选择
- **一次性付款**：传统的全额付款
- **分期付款**：支持灵活的分期配置

### 2. 分期付款配置选项
- **分期期数**：1-60期可选
- **首付金额**：可设置首付金额
- **每期金额**：常规分期金额
- **最后一期金额**：可设置不同的最后一期金额

### 3. 自动计算功能
- 根据总金额、首付、最后一期金额自动计算每期金额
- 实时显示分期付款摘要
- 验证分期总额与总金额的一致性

## 使用场景示例

### 场景1：等额分期（无首付）
```
总金额：$12,000
分期期数：12期
首付：$0
每期金额：$1,000
最后一期：$0（使用每期金额）
```

### 场景2：有首付的等额分期
```
总金额：$12,000
分期期数：12期
首付：$2,000
每期金额：$1,000
最后一期：$0（使用每期金额）
```

### 场景3：不等额最后一期
```
总金额：$12,000
分期期数：12期
首付：$2,000
每期金额：$900
最后一期：$1,000
```

## 操作步骤

### 1. 创建分期付款交易
1. 点击 "Add Transaction"
2. 选择交易类型：**Sale**
3. 填写总金额和基本信息

### 2. 配置分期付款
1. 在分期付款配置区域选择 **"分期付款"**
2. 设置分期期数（如：12期）
3. 设置首付金额（如：$2,000）
4. 系统自动计算每期金额
5. 可选择设置不同的最后一期金额

### 3. 查看分期摘要
系统会实时显示：
- 总金额
- 首付金额
- 分期期数
- 常规分期金额
- 最后一期金额（如果设置）
- 分期总额验证

## 自动计算逻辑

### 计算公式
```
剩余金额 = 总金额 - 首付金额 - 最后一期金额
每期金额 = 剩余金额 ÷ (分期期数 - 1)  // 如果设置了最后一期
每期金额 = 剩余金额 ÷ 分期期数        // 如果没有设置最后一期
```

### 验证逻辑
```
分期总额 = 首付金额 + (每期金额 × 常规期数) + 最后一期金额
分期总额应该等于总金额
```

## 界面功能

### 1. 付款方式选择
- 下拉菜单选择 "一次性付款" 或 "分期付款"
- 选择分期付款后显示详细配置选项

### 2. 分期配置表单
- **分期期数**：数字输入框，1-60期
- **首付金额**：货币输入框，支持小数点
- **每期金额**：自动计算，可手动调整
- **最后一期金额**：可选设置，默认为0

### 3. 实时摘要显示
- 蓝色背景的摘要卡片
- 显示所有分期信息
- 验证分期总额与总金额

## 技术实现

### 类型定义
```typescript
interface TransactionWithRequiredFields {
  // 基础字段
  domain_id: string;
  type: 'sell' | 'installment_payment' | ...;
  amount: number;
  
  // 分期付款字段
  payment_plan?: 'lump_sum' | 'installment';
  installment_period?: number;
  downpayment_amount?: number;
  installment_amount?: number;
  final_payment_amount?: number;
  total_installment_amount?: number;
}
```

### 自动计算逻辑
```typescript
useEffect(() => {
  if (payment_plan === 'installment' && amount > 0 && installment_period > 0) {
    const remainingAmount = amount - downpayment_amount - final_payment_amount;
    const regularPeriods = installment_period - (final_payment_amount > 0 ? 1 : 0);
    
    if (regularPeriods > 0) {
      const calculatedAmount = remainingAmount / regularPeriods;
      setInstallmentAmount(calculatedAmount);
    }
  }
}, [amount, downpayment_amount, final_payment_amount, installment_period]);
```

## 最佳实践

### 1. 分期设置建议
- **短期分期**：1-6期，适合小额交易
- **中期分期**：6-24期，适合中等金额
- **长期分期**：24-60期，适合大额交易

### 2. 首付设置建议
- **无首付**：适合信任度高的客户
- **小额首付**：10-20%，降低风险
- **大额首付**：30-50%，确保客户诚意

### 3. 最后一期设置
- **等额分期**：最后一期使用常规金额
- **不等额分期**：最后一期可设置不同金额
- **尾款分期**：最后一期设置较大金额

## 注意事项

1. **金额验证**：分期总额必须等于总金额
2. **期数限制**：最多支持60期分期
3. **自动计算**：修改总金额、首付或最后一期时会自动重新计算
4. **手动调整**：可以手动调整每期金额，系统会重新计算
5. **数据保存**：所有分期配置都会保存到交易记录中

## 多语言支持

- **中文界面**：完整的中文标签和提示
- **英文界面**：完整的英文标签和提示
- **货币格式**：支持多种货币格式显示

这个功能让分期付款配置变得简单直观，支持各种复杂的分期场景！

# ç”¨æˆ·æ•°æ®å®‰å…¨æŠ¥å‘Š

## ğŸ”’ **å®‰å…¨çŠ¶æ€æ€»ç»“**

### âœ… **å·²å®ç°çš„å®‰å…¨æªæ–½**

#### 1. **è®¤è¯ç³»ç»Ÿå®‰å…¨**
- **è®¤è¯æ–¹å¼**: Supabaseå†…ç½®è®¤è¯ç³»ç»Ÿ
- **å¯†ç å­˜å‚¨**: ç”±Supabaseä½¿ç”¨bcryptåŠ å¯†å­˜å‚¨ï¼ˆä¸åœ¨åº”ç”¨å±‚å¤„ç†ï¼‰
- **è®¤è¯æµç¨‹**: Magic Linkè®¤è¯ï¼Œæ— éœ€å¯†ç 
- **ä¼šè¯ç®¡ç†**: Supabase JWTä»¤ç‰Œï¼Œè‡ªåŠ¨è¿‡æœŸæœºåˆ¶

#### 2. **æ•°æ®å­˜å‚¨å®‰å…¨**
- **ä¸»è®¤è¯è¡¨**: `auth.users` (Supabaseç®¡ç†)
- **åº”ç”¨ç”¨æˆ·è¡¨**: `public.users` (åº”ç”¨ç®¡ç†)
- **åŒæ­¥æœºåˆ¶**: æ•°æ®åº“è§¦å‘å™¨è‡ªåŠ¨åŒæ­¥
- **æ•°æ®éš”ç¦»**: RLSç­–ç•¥ç¡®ä¿ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®

#### 3. **APIå®‰å…¨**
- **èº«ä»½éªŒè¯**: æ‰€æœ‰APIéƒ½éªŒè¯ç”¨æˆ·ä¼šè¯
- **æƒé™æ§åˆ¶**: ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
- **æ•°æ®è¿‡æ»¤**: é€šè¿‡RLSç­–ç•¥å’Œæ˜¾å¼ç”¨æˆ·éªŒè¯

### ğŸ”§ **æŠ€æœ¯å®ç°ç»†èŠ‚**

#### **ç”¨æˆ·è®¤è¯æµç¨‹**
```typescript
// 1. ç”¨æˆ·è¾“å…¥é‚®ç®±
const { data, error } = await supabase.auth.signInWithOtp({
  email,
  options: {
    emailRedirectTo: redirectUrl,
    shouldCreateUser: true
  }
});

// 2. ç”¨æˆ·ç‚¹å‡»Magic Link
const { data, error } = await supabase.auth.setSession({
  access_token,
  refresh_token
});

// 3. è‡ªåŠ¨åŒæ­¥åˆ°public.usersè¡¨ï¼ˆé€šè¿‡æ•°æ®åº“è§¦å‘å™¨ï¼‰
```

#### **æ•°æ®åŒæ­¥æœºåˆ¶**
```sql
-- è‡ªåŠ¨åŒæ­¥è§¦å‘å™¨
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.users (id, email, email_verified, created_at, updated_at)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.email_confirmed_at IS NOT NULL, false),
    NEW.created_at,
    NEW.updated_at
  )
  ON CONFLICT (id) DO UPDATE SET
    email = EXCLUDED.email,
    email_verified = COALESCE(NEW.email_confirmed_at IS NOT NULL, false),
    updated_at = NEW.updated_at;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

#### **æ•°æ®éš”ç¦»æœºåˆ¶**
```sql
-- RLSç­–ç•¥ç¡®ä¿æ•°æ®éš”ç¦»
CREATE POLICY "Users can view own domains" ON domains
  FOR SELECT USING (auth.uid() = owner_user_id);

CREATE POLICY "Users can insert own domains" ON domains
  FOR INSERT WITH CHECK (auth.uid() = owner_user_id);
```

### ğŸ›¡ï¸ **å®‰å…¨ç‰¹æ€§**

#### **å¯†ç å®‰å…¨**
- âœ… å¯†ç ç”±Supabaseä½¿ç”¨bcryptåŠ å¯†å­˜å‚¨
- âœ… åº”ç”¨å±‚ä¸å¤„ç†å¯†ç 
- âœ… ä½¿ç”¨Magic Linkè®¤è¯ï¼Œæ— éœ€å¯†ç 

#### **ä¼šè¯å®‰å…¨**
- âœ… JWTä»¤ç‰Œè‡ªåŠ¨è¿‡æœŸ
- âœ… å®‰å…¨çš„ä»¤ç‰Œç”Ÿæˆå’ŒéªŒè¯
- âœ… ä¼šè¯çŠ¶æ€å®æ—¶åŒæ­¥

#### **æ•°æ®å®‰å…¨**
- âœ… æ‰€æœ‰æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- âœ… ç”¨æˆ·æ•°æ®å®Œå…¨éš”ç¦»
- âœ… é˜²æ­¢è¶Šæƒè®¿é—®

#### **APIå®‰å…¨**
- âœ… æ‰€æœ‰APIéƒ½éªŒè¯ç”¨æˆ·èº«ä»½
- âœ… é˜²æ­¢SQLæ³¨å…¥æ”»å‡»
- âœ… é˜²æ­¢CSRFæ”»å‡»

### ğŸ“Š **æ•°æ®æµå›¾**

```
ç”¨æˆ·æ³¨å†Œ/ç™»å½•
    â†“
Supabase Auth (auth.users)
    â†“ (æ•°æ®åº“è§¦å‘å™¨)
Public Users (public.users)
    â†“
åº”ç”¨æ•°æ® (domains, transactions)
    â†“ (RLSç­–ç•¥)
ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
```

### ğŸ” **å®‰å…¨éªŒè¯**

#### **å·²é€šè¿‡çš„å®‰å…¨æ£€æŸ¥**
- âœ… ç”¨æˆ·è®¤è¯ç³»ç»Ÿå®‰å…¨
- âœ… å¯†ç å­˜å‚¨å®‰å…¨
- âœ… æ•°æ®éš”ç¦»å®Œæ•´
- âœ… APIæƒé™æ§åˆ¶
- âœ… ä¼šè¯ç®¡ç†å®‰å…¨

#### **å»ºè®®çš„å®šæœŸæ£€æŸ¥**
- ğŸ”„ å®šæœŸéªŒè¯RLSç­–ç•¥æ˜¯å¦æ­£å¸¸å·¥ä½œ
- ğŸ”„ æ£€æŸ¥ç”¨æˆ·åŒæ­¥æ˜¯å¦å®Œæ•´
- ğŸ”„ ç›‘æ§å¼‚å¸¸ç™»å½•æ´»åŠ¨
- ğŸ”„ å®šæœŸæ›´æ–°ä¾èµ–åŒ…

### ğŸ¯ **æ€»ç»“**

å½“å‰çš„ç”¨æˆ·æ•°æ®å®‰å…¨å®ç°æ˜¯**ç”Ÿäº§å°±ç»ª**çš„ï¼Œå…·å¤‡ï¼š

1. **ä¼ä¸šçº§è®¤è¯å®‰å…¨**: ä½¿ç”¨Supabaseå†…ç½®è®¤è¯ç³»ç»Ÿ
2. **å®Œæ•´çš„æ•°æ®éš”ç¦»**: RLSç­–ç•¥ç¡®ä¿ç”¨æˆ·æ•°æ®å®‰å…¨
3. **è‡ªåŠ¨åŒæ­¥æœºåˆ¶**: æ•°æ®åº“è§¦å‘å™¨ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
4. **APIå®‰å…¨**: æ‰€æœ‰æ¥å£éƒ½æœ‰èº«ä»½éªŒè¯å’Œæƒé™æ§åˆ¶

**å®‰å…¨ç­‰çº§**: ğŸŸ¢ **é«˜** - ç¬¦åˆç°ä»£Webåº”ç”¨å®‰å…¨æ ‡å‡†
